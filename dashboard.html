<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitkub Pro Bot</title>
    <link rel="icon" href="/static/favicon.svg" type="image/svg+xml" />
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .log-terminal { font-family: 'Consolas', 'Monaco', monospace; font-size: 0.85rem; }
        
        /* Modal Animation */
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow: hidden; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-y-auto md:overflow-hidden">

    <header class="bg-slate-900 border-b border-slate-700 p-3 md:p-4 flex flex-col md:flex-row justify-between items-center shadow-lg gap-3 sticky top-0 z-40 w-full">
        <div class="flex items-center gap-3 w-full md:w-auto justify-center md:justify-start">
            <i class="fa-solid fa-robot text-green-400 text-2xl"></i>
            <h1 class="text-xl font-bold text-white tracking-wide">Bitkub <span class="text-green-400">Pro Bot</span></h1>
            <span id="connection-status" class="ml-2 text-xs text-slate-500"></span> 
        </div>
          
        <div class="flex items-center gap-4 w-full md:w-auto justify-center md:justify-end">  

            <div class="px-3 py-1 rounded-full text-sm font-bold bg-blue-900 text-blue-200 border border-blue-700 shadow-inner">
                <i class="fa-solid fa-wallet mr-1 text-blue-400"></i> <span id="wallet-thb">‡∏ø 0.00</span>
            </div>
            <div id="status-badge" class="px-3 py-1 rounded-full text-sm font-semibold bg-gray-600 text-gray-200">
                <span class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-gray-400" id="status-dot"></span>
                    <span id="status-text">Checking...</span>
                </span>
            </div>

           <button id="toggle-btn" onclick="toggleBot()" class="px-2 py-1 text-xs rounded-md font-bold text-white transition-all duration-200 bg-gray-500 cursor-wait" disabled>
                Loading...
            </button>
            
            <button onclick="logout()" class="text-gray-400 hover:text-white ml-2" title="Logout">
                <i class="fas fa-sign-out-alt"></i> 
            </button>
        </div>
    </header>

    <main class="flex-1 flex flex-col md:flex-row gap-4 p-2 md:p-4 overflow-visible md:overflow-hidden">
        
        <div class="w-full md:w-1/3 flex flex-col gap-4 order-2 md:order-1">
            
            <button onclick="openAddModal()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg flex items-center justify-center gap-2 transition transform hover:scale-[1.01] active:scale-95">
                <i class="fa-solid fa-plus-circle text-xl"></i> <span>Add New Symbol</span>
            </button>

            <div class="glass-panel rounded-lg p-3 md:p-4 shadow-lg flex-col overflow-hidden h-96 md:h-auto md:flex-1 flex">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-base md:text-lg font-bold text-yellow-400"><i class="fa-solid fa-list"></i> Watchlist</h2>
                    <button onclick="fetchSymbols()" class="text-slate-400 hover:text-white bg-slate-800 p-2 rounded-full" title="Refresh">
                        <i class="fa-solid fa-rotate"></i>
                    </button>
                </div>
                <div class="overflow-auto flex-1">
                    <table class="w-full text-left border-collapse whitespace-nowrap">
                        <thead class="bg-slate-800 text-slate-300 sticky top-0 z-10">
                            <tr>
                                <th class="p-2 text-xs uppercase">Symbol</th>
                                <th class="p-2 text-xs uppercase text-right">Cost/Coin</th>
                                <th class="p-2 text-xs uppercase text-right">Price/PnL</th> 
                                <th class="p-2 text-xs uppercase text-center">Status</th>
                                <th class="p-2 text-xs uppercase text-center">Action</th> 
                            </tr>
                        </thead>
                        <tbody id="symbolTableBody" class="text-sm divide-y divide-slate-700"></tbody>
                    </table>
                </div>
            </div>

            <div class="glass-panel rounded-lg p-3 md:p-4 shadow-lg flex-col overflow-hidden h-80 md:h-[40%] flex">
                <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-2">
                    <h2 class="text-sm font-bold text-white"><i class="fa-solid fa-scroll text-slate-400"></i> History</h2>
                    <button class="text-xs bg-slate-700 hover:bg-slate-600 text-white px-2 py-1 rounded" onclick="loadHistory()">Refresh</button>
                </div>
                <div class="overflow-auto flex-1">
                    <table class="w-full text-left text-xs whitespace-nowrap">
                        <thead class="bg-slate-800 text-slate-400 sticky top-0 z-10">
                            <tr>
                                <th class="p-2">Time</th>
                                <th class="p-2">Sym</th>
                                <th class="p-2">Type</th>
                                <th class="p-2">Price</th>
                                <th class="p-2">Amt</th>
                                <th class="p-2">Reason</th>
                            </tr>
                        </thead>
                        <tbody id="historyTable" class="divide-y divide-slate-700"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="w-full md:w-2/3 glass-panel rounded-lg shadow-lg flex flex-col overflow-hidden h-80 md:h-auto order-1 md:order-2">
            <div class="bg-slate-800 p-3 border-b border-slate-700 flex justify-between items-center sticky top-0">
                <h2 class="text-base md:text-lg font-bold text-green-400"><i class="fa-solid fa-terminal"></i> Terminal</h2>
                <button onclick="clearLogs()" class="text-xs bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded text-slate-300">Clear</button>
            </div>
            <div id="logContainer" class="flex-1 p-3 md:p-4 overflow-y-auto log-terminal bg-black text-green-500 space-y-1 text-xs md:text-sm"></div>
        </div>
    </main>

    <div id="addModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50 p-4">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-80 backdrop-blur-sm"></div>
        <div class="modal-container bg-slate-800 w-full md:w-1/3 mx-auto rounded-lg shadow-2xl z-50 overflow-y-auto border border-slate-600 transform transition-all scale-95 max-h-[90vh]" id="addModalContent">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3 border-b border-slate-700">
                    <p class="text-xl font-bold text-blue-400">üöÄ Add Watchlist</p>
                    <div class="cursor-pointer z-50 text-slate-400 hover:text-white p-2" onclick="closeAddModal()">
                        <i class="fa-solid fa-times text-xl"></i>
                    </div>
                </div>

                <div class="my-5">
                    <div class="mb-4">
                        <label class="block text-slate-300 text-sm font-bold mb-2">Symbol (e.g. BTC)</label>
                        <input id="addSymInput" type="text" placeholder="THB_BTC" class="shadow appearance-none border border-slate-600 rounded w-full py-3 px-3 text-white bg-slate-700 leading-tight focus:outline-none focus:border-blue-500 uppercase text-lg">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="mb-4">
                            <label class="block text-slate-300 text-sm font-bold mb-2">Buy Amount (THB)</label>
                            <input id="addCostStInput" type="number" value="100" class="shadow appearance-none border border-slate-600 rounded w-full py-2 px-3 text-white bg-slate-700 focus:border-blue-500">
                        </div>
                        <div class="mb-4">
                            <label class="block text-slate-300 text-sm font-bold mb-2">Max Limit (THB)</label>
                            <input id="addLimitInput" type="number" value="1000" class="shadow appearance-none border border-slate-600 rounded w-full py-2 px-3 text-white bg-slate-700 focus:border-blue-500">
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-300 text-sm font-bold mb-2">Trading Strategy</label>
                    <select id="addStrategy" class="shadow appearance-none border border-slate-600 rounded w-full py-2 px-3 text-white bg-slate-700 leading-tight focus:border-blue-500">
                        <option value="1">Strategy 1: Trend & Reversal (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢)</option>
                        <option value="2">Strategy 2: RSI Scalping (‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏±‡πâ‡∏ô/‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡πÑ‡∏ß)</option>
                        <option value="3">Strategy 3: MACD Cross (‡∏ï‡∏≤‡∏°‡πÄ‡∏ó‡∏£‡∏ô‡∏î‡πå‡∏¢‡∏≤‡∏ß)</option>
                        <option value="4" class="text-yellow-400 font-bold">Strategy 4: ü§ñ Auto AI (‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ï‡∏•‡∏≤‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</option>
                    </select>
                </div>

                <div class="flex justify-end pt-2 border-t border-slate-700 gap-2">
                    <button onclick="closeAddModal()" class="flex-1 md:flex-none px-4 bg-transparent p-3 rounded-lg text-slate-400 hover:bg-slate-700 hover:text-white border border-slate-600 md:border-0">Cancel</button>
                    <button onclick="addSymbol()" class="flex-1 md:flex-none px-6 bg-blue-600 p-3 rounded-lg text-white hover:bg-blue-500 font-bold shadow-lg">Add Symbol</button>
                </div>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50 p-4">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-80 backdrop-blur-sm"></div>
        <div class="modal-container bg-slate-800 w-full md:w-1/3 mx-auto rounded-lg shadow-2xl z-50 overflow-y-auto border border-slate-600 max-h-[90vh]">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3 border-b border-slate-700">
                    <p class="text-xl font-bold text-yellow-400">‚öôÔ∏è Edit Settings</p>
                    <div class="cursor-pointer z-50 text-slate-400 hover:text-white p-2" onclick="closeModal()">
                        <i class="fa-solid fa-times text-xl"></i>
                    </div>
                </div>

                <div class="my-5">
                    <input type="hidden" id="editId">
                    <div class="mb-4">
                        <label class="block text-slate-500 text-sm font-bold mb-2">Symbol (Read Only)</label>
                        <input id="editSymbol" type="text" class="shadow appearance-none border border-slate-600 rounded w-full py-3 px-3 text-slate-400 bg-slate-900 leading-tight focus:outline-none" readonly>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="mb-4">
                            <label class="block text-slate-300 text-sm font-bold mb-2">Buy Amount (THB)</label>
                            <input id="editCostSt" type="number" class="shadow appearance-none border border-slate-600 rounded w-full py-2 px-3 text-white bg-slate-700 leading-tight focus:outline-none focus:border-yellow-500">
                        </div>
                        <div class="mb-4">
                            <label class="block text-slate-300 text-sm font-bold mb-2">Max Limit (THB)</label>
                            <input id="editLimit" type="number" class="shadow appearance-none border border-slate-600 rounded w-full py-2 px-3 text-white bg-slate-700 leading-tight focus:outline-none focus:border-yellow-500">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-slate-300 text-sm font-bold mb-2">Status</label>
                        <select id="editStatus" class="shadow border border-slate-600 rounded w-full py-3 px-3 text-white bg-slate-700 leading-tight focus:outline-none focus:border-yellow-500 h-12">
                            <option value="true">Active (ON)</option>
                            <option value="false">Inactive (OFF)</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-300 text-sm font-bold mb-2">Trading Strategy</label>
                        <select id="editStrategy" class="shadow appearance-none border border-slate-600 rounded w-full py-2 px-3 text-white bg-slate-700 leading-tight focus:border-yellow-500">
                            <option value="1">Strategy 1: Trend & Reversal (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢)</option>
                            <option value="2">Strategy 2: RSI Scalping (‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏±‡πâ‡∏ô/‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡πÑ‡∏ß)</option>
                            <option value="3">Strategy 3: MACD Cross (‡∏ï‡∏≤‡∏°‡πÄ‡∏ó‡∏£‡∏ô‡∏î‡πå‡∏¢‡∏≤‡∏ß)</option>
                            <option value="4" class="text-yellow-400 font-bold">Strategy 4: ü§ñ Auto AI (‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ï‡∏•‡∏≤‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</option>
                        </select>
                    </div>
                </div>

                <div class="flex justify-end pt-2 border-t border-slate-700 gap-2">
                    <button onclick="closeModal()" class="flex-1 md:flex-none px-4 bg-transparent p-3 rounded-lg text-slate-400 hover:bg-slate-700 hover:text-white border border-slate-600 md:border-0">Cancel</button>
                    <button onclick="saveChanges()" class="flex-1 md:flex-none px-6 bg-yellow-600 p-3 rounded-lg text-white hover:bg-yellow-500 font-bold shadow-lg">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = location.protocol + '//' + location.host;
        const WS_URL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + "/ws";

        let isBotRunning = false;

        // --- WebSocket & Basic Functions ---
        function connectWebSocket() {
            const ws = new WebSocket(WS_URL);
            const statusEl = document.getElementById('connection-status');
            ws.onopen = () => { 
                if(statusEl) {
                    statusEl.innerHTML = '<i class="fa-solid fa-circle text-[8px] md:text-[10px]"></i> Online'; 
                    statusEl.className = "ml-2 flex items-center gap-2 text-green-500 text-xs md:text-sm font-semibold whitespace-nowrap"; 
                }
            };
            ws.onmessage = (event) => { appendLog(event.data); };
            ws.onclose = () => { setTimeout(connectWebSocket, 3000); };
        }

        function appendLog(message) {
            const container = document.getElementById('logContainer');
            const now = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            let color = "text-green-500";
            if(message.includes("SELL") || message.includes("Error")) color = "text-red-400";
            div.className = `border-b border-slate-900 pb-1 break-words ${color}`;
            div.innerHTML = `<span class="text-slate-500 mr-2 text-[10px] md:text-xs">[${now}]</span> ${message}`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // --- CRUD Functions & PnL Calculation ---
        
        async function fetchSymbols() {
            try {
                const res = await fetch(`${API_URL}/symbols`);
                const symbols = await res.json();

                let tickerData = {};
                try {
                    const tickerRes = await fetch(`${API_URL}/api/ticker`);
                    tickerData = await tickerRes.json();
                } catch (e) {}

                // üü¢ 1. [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏†‡∏≤‡∏ß‡∏∞‡∏ï‡∏•‡∏≤‡∏î (Market Regime)
                let regimeData = {};
                try {
                    const regimeRes = await fetch(`${API_URL}/api/market-regime`);
                    regimeData = await regimeRes.json();
                } catch (e) {}

                const tbody = document.getElementById('symbolTableBody');
                tbody.innerHTML = '';

                symbols.forEach(sym => {
                    const statusClass = sym.status === 'true' ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300';
                    const statusText = sym.status === 'true' ? 'ON' : 'OFF';
                    const strategyNum = sym.strategy || 1; 
                    
                    // üü¢ 2. [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏î‡∏∂‡∏á‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏•‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ô‡∏µ‡πâ ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏ä‡∏ß‡πå
                    // üü¢ 2. ‡∏î‡∏∂‡∏á‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏•‡∏≤‡∏î ‡πÅ‡∏•‡∏∞ ‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏ó‡∏µ‡πà Auto AI ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ ‡∏ì ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
                    const regimeDataObj = regimeData[sym.symbol] || { regime: "‚è≥ Analyzing...", active_strat: strategyNum };
                    
                    const regimeBadge = regimeData[sym.symbol] 
                        ? `<span class="bg-slate-800 text-yellow-300 border border-slate-600 px-1.5 py-0.5 rounded text-[10px] whitespace-nowrap">${regimeDataObj.regime}</span>` 
                        : `<span class="text-slate-600 text-[10px]">‚è≥ Analyzing...</span>`;
                    
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î 4 ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ AI ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Strat ‡πÑ‡∏´‡∏ô‡πÉ‡∏´‡πâ
                    const displayStrat = strategyNum == 4 
                        ? `<span class="text-yellow-400 font-bold">4 (Auto ‚û°Ô∏è S${regimeDataObj.active_strat})</span>` 
                        : strategyNum;
                    
                    // ... (‡πÇ‡∏Ñ‡πâ‡∏î PnL ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ...
                    
                    let currentPrice = 0;
                    let pnlPct = 0;
                    let pnlTHB = 0;
                    let pnlColor = "text-slate-500";
                    let pnlSign = "";

                    if (tickerData && tickerData[sym.symbol]) {
                        currentPrice = tickerData[sym.symbol].last;
                    }

                    if (sym.coin > 0 && currentPrice > 0) {
                        const currentValue = sym.coin * currentPrice; 
                        pnlTHB = currentValue - sym.cost; 
                        pnlPct = (pnlTHB / sym.cost) * 100; 

                        if (pnlTHB > 0) {
                            pnlColor = "text-green-400";
                            pnlSign = "+";
                        } else if (pnlTHB < 0) {
                            pnlColor = "text-red-400";
                        }
                    }

                    const row = `
                        <tr class="hover:bg-slate-700 transition group border-b border-slate-700 last:border-0">
                            <td class="p-2">
                                <div class="font-bold text-white mb-1">${sym.symbol}</div>
                                <div>${regimeBadge}</div>
                                <div class="text-slate-500 text-[10px] mt-1">Strategy: ${displayStrat}</div>
                            </td>
                            <td class="p-2 text-right">
                                <div class="text-slate-300 text-xs">${parseFloat(sym.cost).toFixed(2)} ‡∏ø</div>
                                <div class="text-slate-500 text-[10px]">${parseFloat(sym.coin).toFixed(6)}</div>
                            </td>
                            
                            <td class="p-2 text-right">
                                <div class="text-xs ${sym.coin > 0 ? 'text-white' : 'text-slate-500'}">
                                    ${currentPrice > 0 ? currentPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 4}) : '...'}
                                </div>
                                ${sym.coin > 0 
                                    ? `<div class="${pnlColor} text-[10px] font-bold">${pnlSign}${pnlPct.toFixed(2)}% (${pnlSign}${pnlTHB.toFixed(2)} ‡∏ø)</div>` 
                                    : `<div class="text-slate-600 text-[10px]">No Position</div>`
                                }
                            </td>

                            <td class="p-2 text-center">
                                <span class="text-[10px] px-2 py-0.5 rounded-full ${statusClass}">${statusText}</span>
                            </td>
                            <td class="p-2 text-center">
                                <button onclick='openEditModal(${JSON.stringify(sym)})' class="text-blue-400 hover:text-blue-300 mx-1 bg-slate-800 p-1.5 rounded" title="Edit">
                                    <i class="fa-solid fa-pen-to-square"></i>
                                </button>
                                <button onclick="deleteSymbol(${sym.id})" class="text-red-500 hover:text-red-400 mx-1 bg-slate-800 p-1.5 rounded" title="Delete">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } catch (e) { console.error("Fetch symbols error:", e); }
        }

        // --- ADD MODAL LOGIC ---
        function openAddModal() {
            document.getElementById('addSymInput').value = '';
            document.getElementById('addCostStInput').value = '100';
            document.getElementById('addLimitInput').value = '1000';
            document.getElementById('addStrategy').value = '1'; 
            
            const modal = document.getElementById('addModal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            document.body.classList.add('modal-active');
            
            setTimeout(() => document.getElementById('addSymInput').focus(), 100);
        }

        function closeAddModal() {
            const modal = document.getElementById('addModal');
            modal.classList.add('opacity-0', 'pointer-events-none');
            document.body.classList.remove('modal-active');
        }

        async function addSymbol() {
            const symbol = document.getElementById('addSymInput').value.toUpperCase();
            const costSt = document.getElementById('addCostStInput').value;
            const moneyLimit = document.getElementById('addLimitInput').value;
            const strategy = document.getElementById('addStrategy').value; 

            if(!symbol) { alert("Please enter a symbol"); return; }

            try {
                await fetch(`${API_URL}/add_symbol`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        symbol, 
                        cost_st: parseFloat(costSt), 
                        money_limit: parseFloat(moneyLimit), 
                        status: 'true',
                        strategy: parseInt(strategy)
                    })
                });
                closeAddModal();
                fetchSymbols();
                appendLog(`Action: Added ${symbol} (Strategy ${strategy})`);
            } catch (e) { alert(e); }
        }

        // --- EDIT & DELETE LOGIC ---

        async function deleteSymbol(id) {
            if(!confirm("Are you sure you want to delete this symbol?")) return;
            try {
                await fetch(`${API_URL}/delete_symbol/${id}`, { method: 'DELETE' });
                fetchSymbols();
                appendLog(`Action: Deleted ID ${id}`);
            } catch (e) { alert("Delete failed"); }
        }

        function openEditModal(sym) {
            document.getElementById('editId').value = sym.id;
            document.getElementById('editSymbol').value = sym.symbol;
            document.getElementById('editCostSt').value = sym.cost_st;
            document.getElementById('editLimit').value = sym.money_limit;
            document.getElementById('editStatus').value = sym.status;
            document.getElementById('editStrategy').value = sym.strategy || 1; 

            const modal = document.getElementById('editModal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            document.body.classList.add('modal-active');
        }

        function closeModal() {
            const modal = document.getElementById('editModal');
            modal.classList.add('opacity-0', 'pointer-events-none');
            document.body.classList.remove('modal-active');
        }

        async function saveChanges() {
            const id = document.getElementById('editId').value;
            const data = {
                status: document.getElementById('editStatus').value,
                cost_st: parseFloat(document.getElementById('editCostSt').value),
                money_limit: parseFloat(document.getElementById('editLimit').value),
                strategy: parseInt(document.getElementById('editStrategy').value)
            };

            try {
                const res = await fetch(`${API_URL}/update_symbol/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if(res.ok) {
                    closeModal();
                    fetchSymbols();
                    appendLog(`Action: Updated ID ${id}`);
                } else {
                    alert("Update failed");
                }
            } catch (e) { alert("Error updating symbol"); }
        }

        // Start/Stop/Logout Functions
        function clearLogs() { document.getElementById('logContainer').innerHTML = ''; }

        async function logout() {
            if(!confirm("Disconnect from Dashboard?")) return;
            try {
                await fetch('/logout', { method: 'POST' });
                window.location.href = '/login'; // üü¢ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å reload ‡πÄ‡∏õ‡πá‡∏ô redirect ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ login ‡∏ä‡∏±‡∏ß‡∏£‡πå‡∏™‡∏∏‡∏î
            } catch (e) { alert("Logout failed"); }
        }

        async function loadHistory() {
            try {
                const res = await fetch('/history');
                const data = await res.json();
                const tbody = document.getElementById('historyTable');
                tbody.innerHTML = ''; 

                data.forEach(order => {
                    const date = new Date(order.ts * 1000).toLocaleString('th-TH', { hour: '2-digit', minute:'2-digit', day: 'numeric', month:'short' });
                    const typeColor = order.type.toLowerCase() === 'buy' ? 'text-green-400' : 'text-red-400';
                    const typeLabel = order.type.toUpperCase();

                    const row = `
                        <tr class="hover:bg-slate-700 transition">
                            <td class="p-2 text-slate-400 whitespace-nowrap">${date}</td>
                            <td class="p-2 font-bold text-white">${order.symbol}</td>
                            <td class="p-2 ${typeColor} font-bold">${typeLabel}</td>
                            <td class="p-2 text-right">${parseFloat(order.rate).toLocaleString()}</td>
                            <td class="p-2 text-right">${parseFloat(order.amount).toLocaleString()}</td>
                            <td class="p-2 text-slate-500 truncate max-w-[100px]" title="${order.reason}">${order.reason}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } catch (error) { console.error("Error loading history:", error); }
        }

        function updateUI(running) {
            isBotRunning = running;
            const btn = document.getElementById('toggle-btn');
            const badge = document.getElementById('status-badge');
            const statusText = document.getElementById('status-text');
            const statusDot = document.getElementById('status-dot');

            btn.disabled = false;
            btn.classList.remove('cursor-wait', 'bg-gray-500');
            
            if (running) {
                btn.innerText = "‚èπ Stop Bot";
                btn.classList.add('bg-red-600', 'hover:bg-red-700'); 
                btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                
                statusText.innerText = "Running";
                statusDot.classList.replace('bg-gray-400', 'bg-green-400');
                badge.classList.replace('bg-gray-600', 'bg-green-900');
                badge.classList.replace('text-gray-200', 'text-green-100');
            } else {
                btn.innerText = "‚ñ∂ Start Bot";
                btn.classList.add('bg-green-600', 'hover:bg-green-700'); 
                btn.classList.remove('bg-red-600', 'hover:bg-red-700');

                statusText.innerText = "Stopped";
                statusDot.classList.replace('bg-green-400', 'bg-gray-400'); 
                badge.classList.replace('bg-green-900', 'bg-gray-600');
                badge.classList.replace('text-green-100', 'text-gray-200');
            }
        }

        async function toggleBot() {
            // üü¢ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞ "‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏≠‡∏ó"
            if (isBotRunning) {
                const confirmStop = confirm("‚ö†Ô∏è ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ '‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏≠‡∏ó'?\n\n(‡∏´‡∏≤‡∏Å‡∏´‡∏¢‡∏∏‡∏î ‡∏ö‡∏≠‡∏ó‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ù‡πâ‡∏≤‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏Å‡∏î Start ‡πÉ‡∏´‡∏°‡πà)");
                if (!confirmStop) {
                    return; // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å ‡∏Å‡πá‡πÉ‡∏´‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÑ‡∏õ‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
                }
            }

            const btn = document.getElementById('toggle-btn');
            
            btn.disabled = true;
            btn.innerText = "Processing...";
            
            try {
                let url = isBotRunning ? '/stop-bot' : '/start-bot';
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();

                if (isBotRunning) {
                    updateUI(false); 
                } else {
                    updateUI(true);
                }
            } catch (error) {
                console.error('Error:', error);
                alert("Connection Error!");
                btn.disabled = false;
                updateUI(isBotRunning);
            }
        }

        async function checkInitialStatus() {
            try {
                const response = await fetch('/bot-status'); 
                const data = await response.json();
                updateUI(data.running); 
            } catch (error) {
                console.error("Cannot check status", error);
                updateUI(false);
            }
        }

        // üü¢ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô THB
        async function fetchWalletBalance() {
            try {
                const res = await fetch(`${API_URL}/api/wallet`);
                const data = await res.json();
                if (data.status === 'success') {
                    // ‡∏à‡∏±‡∏î Format ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                    const thbFormatted = parseFloat(data.THB).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    document.getElementById('wallet-thb').innerText = `‡∏ø ${thbFormatted}`;
                }
            } catch (error) {
                console.error("Wallet fetch error:", error);
            }
        }

        // Init
        window.onload = () => {
            connectWebSocket();
            fetchSymbols();
            loadHistory();
            checkInitialStatus();
            fetchWalletBalance();            
            // üü¢ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞ PnL ‡∏ó‡∏∏‡∏Å‡πÜ 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            setInterval(fetchSymbols, 5000);             
            setInterval(loadHistory, 30000);
            setInterval(fetchWalletBalance, 30000);
            setInterval(checkInitialStatus, 5000);
        };
    </script>
</body>
</html>